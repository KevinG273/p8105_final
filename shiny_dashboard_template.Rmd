---
title: "Shiny Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(plotly)
library(ggplot2)
library(leaflet)
```

```{r}
gun_df = read.csv("./data/mass_shootings_2018_2024_cleaned.csv") |>
  janitor::clean_names() |>
  mutate(
    date = as.Date(date, "%Y-%m-%d"),
    year = format(date, "%Y")
  )
```


Column {.sidebar}
-----------------------------------------------------------------------

```{r}
# Select Date Range
dateRangeInput(
  inputId = "date_range",
  label = h3("Select Date Range"),
  start = min(gun_df$date),
  end = max(gun_df$date),
  min = min(gun_df$date),
  max = max(gun_df$date)
)
```

```{r}
# State Dropdown
state_choices = unique(gun_df$state)
selectInput(
  inputId = "state_choice",
  label = h3("Select State"),
  choices = c("All", state_choices),
  selected = "All"
)
```

```{r}
# Slider for Top N States
sliderInput(
  inputId = "top_n",
  label = h3("Select Top N States"),
  min = 1,
  max = length(unique(gun_df$state)),
  value = 10
)
```


Column {data-width=650}
-----------------------------------------------------------------------

### Incidents Per Capita

```{r}
incidents_per_state = gun_df |>
  group_by(state) |>
  summarize(total_incidents = n())

# Bar chart for total incidents
ggplot(incidents_per_state, aes(x = reorder(state, -total_incidents), y = total_incidents)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  theme_minimal() +
  labs(
    title = "Mass Shootings Total Incidents by State",
    x = "State",
    y = "Total Incidents"
  )
```

Column {data-width=350}
-----------------------------------------------------------------------

### Top States by Incidents

```{r}
renderPlotly({
  filtered_data = gun_df |>
    filter(date >= input$date_range[1], date <= input$date_range[2]) |>
    group_by(state) |>
    summarise(total_incidents = n(), .groups = "drop") |>
    slice_max(order_by = total_incidents, n = input$top_n)
  
  plot_ly(
    data = filtered_data,
    x = ~reorder(state, total_incidents),
    y = ~total_incidents,
    type = "bar",
    text = ~state,
    marker = list(color = 'red')
  ) |>
    layout(
      xaxis = list(title = "State"),
      yaxis = list(title = "Total Incidents"),
      title = "Top States by Gun Violence Incidents"
    )
})
```

### Data Table

```{r}
library(DT)

# Create a summarized data table
data_table = gun_df |>
  group_by(state) |>
  summarize(
    total_incidents = n()
  ) |>
  arrange(desc(total_incidents))

# Display the data table
datatable(
  data_table,
  options = list(
    pageLength = 10,
    autoWidth = TRUE
  ),
  rownames = FALSE,
  caption = "Summary of Mass Shootings by State"
)
```


